<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Fenntarthat√≥s√°g Eur√≥p√°ban √©s a vil√°gban</title>

  <!-- Vega-Lite √©s Vega beilleszt√©se -->
  <script src="https://cdn.jsdelivr.net/npm/vega@5"></script>
  <script src="https://cdn.jsdelivr.net/npm/vega-lite@5"></script>
  <script src="https://cdn.jsdelivr.net/npm/vega-embed@6"></script>
  <!-- D3.js for map utilities -->
  <script src="https://d3js.org/d3.v7.min.js"></script>

  <style>
    body {
      font-family: "Segoe UI", Arial, sans-serif;
      background-color: #f7f9fc;
      margin: 0;
      padding: 0;
      color: #1f2937;
    }

    header {
      background: linear-gradient(90deg, #1e3a8a, #3b82f6);
      color: white;
      text-align: center;
      padding: 2rem 1rem;
      border-bottom: 5px solid #2563eb;
    }

    header h1 {
      margin: 0;
      font-size: 2rem;
    }

    main {
      max-width: 1100px;
      margin: 2rem auto;
      padding: 0 1.5rem;
    }

    section {
      background: white;
      border-radius: 1rem;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      padding: 2rem;
      margin-bottom: 2.5rem;
    }

    h2 {
      color: #1e3a8a;
      font-size: 1.4rem;
      margin-bottom: 0.75rem;
    }

    label, select {
      font-size: 1rem;
      margin-right: 10px;
    }

    select {
      padding: 0.3rem 0.6rem;
      border-radius: 6px;
      border: 1px solid #ccc;
    }

    .chart {
      width: 100%;
      height: 450px;
      position: relative;
    }

    .tooltip {
      opacity: 0;
      transition: opacity 0.2s;
    }

    .tooltip.show {
      opacity: 1;
    }

    /* World map specific styles */
    .country-path {
      stroke: #fff;
      stroke-width: 0.5;
      cursor: pointer;
      transition: opacity 0.2s;
    }

    .country-path:hover {
      opacity: 0.8;
    }

    footer {
      text-align: center;
      color: #6b7280;
      font-size: 0.9rem;
      padding: 1.5rem;
    }
  </style>
</head>

<body>
  <header>
    <h1>üåç Fenntarthat√≥s√°gi trendek a vil√°gban √©s Eur√≥p√°ban</h1>
  </header>

  <main>
    <section>
      <h2>Bevezet√©s</h2>
      <p>
        Ez az oldal a vil√°g fenntarthat√≥s√°gi szintj√©t vizsg√°lja, k√ºl√∂n√∂s tekintettel az
        <strong>eur√≥pai orsz√°gok elektronikai hullad√©k√°nak √∫jrahasznos√≠t√°si ar√°nyaira</strong>.
        Az al√°bbi <strong>n√©gy</strong> vizualiz√°ci√≥ a glob√°lis √©s eur√≥pai k√∂rnyezeti trendeket mutatja be,
        kezdve a CO‚ÇÇ-kibocs√°t√°ssal, majd az elektronikai hullad√©k √∫jrahasznos√≠t√°s√°nak id≈ëbeli
        alakul√°s√°val √©s orsz√°gonk√©nti ar√°nyaival, v√©g√ºl egy interakt√≠v vil√°g t√©rk√©ppel.
      </p>
    </section>

    <!-- 1Ô∏è‚É£ CO‚ÇÇ kibocs√°t√°s id≈ëbeli trend -->
    <section>
      <h2>1. Vizualiz√°ci√≥ ‚Äì CO‚ÇÇ kibocs√°t√°s alakul√°sa orsz√°gonk√©nt</h2>
      <p>Ez a vonaldiagram az egy f≈ëre jut√≥ √©ves CO‚ÇÇ-kibocs√°t√°s v√°ltoz√°s√°t mutatja orsz√°gonk√©nt.</p>

      <label for="co2CountrySelect">V√°lassz orsz√°got/kontinenst:</label>
      <select id="co2CountrySelect">
        <option value="All">Minden</option>
      </select>

      <div id="vis1" class="chart"></div>
    </section>

    <!-- 2Ô∏è‚É£ Elektronikai hullad√©k √∫jrahasznos√≠t√°s id≈ëbeli trend -->
    <section>
      <h2>2. Vizualiz√°ci√≥ ‚Äì Elektronikai hullad√©k √∫jrahasznos√≠t√°s id≈ëbeli trendje</h2>
      <p>
        Ez a vonaldiagram az egyes eur√≥pai orsz√°gok elektronikai hullad√©k √∫jrahasznos√≠t√°si
        ar√°ny√°nak id≈ëbeli alakul√°s√°t mutatja (2005‚Äì2018 k√∂z√∂tt).
      </p>

      <label for="countrySelect">V√°lassz orsz√°got:</label>
      <select id="countrySelect">
        <option value="All">Mindegyik orsz√°g</option>
      </select>

      <div id="vis2" class="chart"></div>
    </section>

    <!-- 3Ô∏è‚É£ Elektronikai hullad√©k √∫jrahasznos√≠t√°s oszlopdiagram -->
    <section>
      <h2>3. Vizualiz√°ci√≥ ‚Äì Elektronikai hullad√©k √∫jrahasznos√≠t√°s ar√°nya orsz√°gonk√©nt</h2>
      <p>
        Ez az oszlopdiagram az eur√≥pai orsz√°gok elektronikai hullad√©k√°nak √∫jrahasznos√≠t√°si ar√°ny√°t mutatja
        az adott √©vben.
      </p>

      <label for="yearSelect">V√°lassz √©vet:</label>
      <select id="yearSelect"></select>

      <div id="vis3" class="chart"></div>
    </section>

    <!-- 4Ô∏è‚É£ World Map - CO2 Emissions -->
    <section>
      <h2>4. Vizualiz√°ci√≥ ‚Äì Vil√°gt√©rk√©p: CO‚ÇÇ kibocs√°t√°s √∂sszes orsz√°gra adott √©vre</h2>
      <p>Ez a t√©rk√©p az √∂sszes orsz√°g egy f≈ëre jut√≥ CO‚ÇÇ-kibocs√°t√°s√°t mutatja a kiv√°lasztott √©vre. Az intenz√≠vebb k√©k sz√≠n magasabb kibocs√°t√°st jel√∂l.</p>
      
      <label for="mapYearSelect">V√°lassz √©vet:</label>
      <select id="mapYearSelect"></select>

      <div id="vis4" class="chart"></div>
      <div id="mapTooltip" class="tooltip" style="opacity: 0; position: absolute; background: rgba(0,0,0,0.8); color: white; padding: 8px; border-radius: 4px; pointer-events: none; z-index: 1000; font-size: 12px;"></div>
    </section>
  </main>

  <footer>
    K√©sz√≠tette: <strong>Fenntarthat√≥s√°gi Vizualiz√°ci√≥s Projekt</strong> ‚Äì 2025
  </footer>

  <script>
    /* 
     * Vega-Lite Specifications are now loaded from external JSON files in the /specs/ directory:
     * - co2-line-chart.json: Chart 1 - CO2 emissions line chart
     * - ewaste-trend-line.json: Chart 2 - E-waste recycling trend line chart  
     * - ewaste-bar-chart.json: Chart 3 - E-waste recycling bar chart by country
     * - world-co2-map.json: Chart 4 - World map of CO2 emissions by country
     * 
     * Each function loads its specification and updates dynamic data (filtered datasets, 
     * color domains, titles) before rendering with vegaEmbed.
     */

    // ===== 1Ô∏è‚É£ CO‚ÇÇ kibocs√°t√°s vonaldiagram =====
    async function drawCO2Line(selectedCountry = "All") {
      const response = await fetch("co-emissions-per-capita.csv");
      const text = await response.text();
      const rows = text.trim().split("\n").map(r => r.split(","));

      rows.shift();

      const data = rows.map(r => ({
        Entity: r[0],
        Code: r[1],
        Year: +r[2],
        Emission: +r[3]
      }));

      // Leg√∂rd√ºl≈ë men√º felt√∂lt√©se
      const countries = [...new Set(data.map(d => d.Entity))].sort();
      const select = document.getElementById("co2CountrySelect");
      if (select.options.length === 1) {
        countries.forEach(c => {
          const opt = document.createElement("option");
          opt.value = c;
          opt.textContent = c;
          select.appendChild(opt);
        });
      }

      const filtered = selectedCountry === "All"
        ? data
        : data.filter(d => d.Entity === selectedCountry);

      // Load specification from external file
      const specResponse = await fetch("specs/co2-line-chart.json");
      const baseSpec1 = await specResponse.json();
      
      // Update data and dynamic parts
      const spec1 = {
        ...baseSpec1,
        data: { values: filtered }
      };

      vegaEmbed("#vis1", spec1, {actions: false});
    }

    document.getElementById("co2CountrySelect")
      .addEventListener("change", e => drawCO2Line(e.target.value));

    drawCO2Line();


    // ===== 2Ô∏è‚É£ Elektronikai hullad√©k trend vonaldiagram =====
    async function drawEWasteTrend(selectedCountry = "All") {
      const response = await fetch("electronic-waste-recycling-rate.csv");
      const text = await response.text();
      const rows = text.trim().split("\n").map(r => r.split(","));

      rows.shift();

      const data = rows.map(r => ({
        Entity: r[0],
        Code: r[1],
        Year: +r[2],
        Rate: +r[3]
      }));

      const countries = [...new Set(data.map(d => d.Entity))].sort();
      const select = document.getElementById("countrySelect");
      if (select.options.length === 1) {
        countries.forEach(c => {
          const opt = document.createElement("option");
          opt.value = c;
          opt.textContent = c;
          select.appendChild(opt);
        });
      }

      const filtered = selectedCountry === "All"
        ? data
        : data.filter(d => d.Entity === selectedCountry);

      // Load specification from external file
      const specResponse2 = await fetch("specs/ewaste-trend-line.json");
      const baseSpec2 = await specResponse2.json();
      
      // Update data and dynamic parts
      const spec2 = {
        ...baseSpec2,
        data: { values: filtered }
      };

      vegaEmbed("#vis2", spec2, {actions: false});
    }

    document.getElementById("countrySelect")
      .addEventListener("change", e => drawEWasteTrend(e.target.value));

    drawEWasteTrend();


    // ===== 3Ô∏è‚É£ Elektronikai hullad√©k orsz√°gonk√©nt ‚Äì oszlopdiagram =====
    async function drawEWasteBar(selectedYear) {
      const response = await fetch("electronic-waste-recycling-rate.csv");
      const text = await response.text();
      const rows = text.trim().split("\n").map(r => r.split(","));

      rows.shift();

      const data = rows.map(r => ({
        Entity: r[0],
        Code: r[1],
        Year: +r[2],
        Rate: +r[3]
      }));

      const years = [...new Set(data.map(d => d.Year))].sort((a, b) => a - b);
      const select = document.getElementById("yearSelect");
      if (select.options.length === 0) {
        years.forEach(y => {
          const opt = document.createElement("option");
          opt.value = y;
          opt.textContent = y;
          select.appendChild(opt);
        });
        select.value = years[years.length - 1];
      }

      const filtered = data.filter(d => d.Year === +select.value);

      // Load specification from external file
      const specResponse3 = await fetch("specs/ewaste-bar-chart.json");
      const baseSpec3 = await specResponse3.json();
      
      // Update data and dynamic parts
      const spec3 = {
        ...baseSpec3,
        data: { values: filtered }
      };

      vegaEmbed("#vis3", spec3, {actions: false});
    }

    document.getElementById("yearSelect")
      .addEventListener("change", e => drawEWasteBar(+e.target.value));

    drawEWasteBar();

    // ===== 4Ô∏è‚É£ World Map - CO‚ÇÇ Emissions Visualization =====
    async function drawWorldMap(selectedYear) {
      const response = await fetch("co-emissions-per-capita.csv"); 
      const text = await response.text();
      const rows = text.trim().split("\n").map(r => r.split(","));

      rows.shift();

      const data = rows.map(r => ({
        Entity: r[0],
        Code: r[1],
        Year: +r[2],
        Emission: +r[3]
      }));

      // Populate year dropdown (similar to chart 3)
      const years = [...new Set(data.map(d => d.Year))].sort((a, b) => a - b);
      const yearSelect = document.getElementById("mapYearSelect");
      if (yearSelect.options.length === 0) {
        years.forEach(y => {
          const opt = document.createElement("option");
          opt.value = y;
          opt.textContent = y;
          yearSelect.appendChild(opt);
        });
        // Default to the most recent year
        yearSelect.value = years[years.length - 1] || 2020;
        selectedYear = +yearSelect.value;
      }

      // Filter data by selected year (like chart 3)
      const filteredData = data.filter(d => d.Year === selectedYear);

      // Get unique countries for this year and their emissions
      const countryData = {};
      filteredData.forEach(d => {
        countryData[d.Entity] = {
          Entity: d.Entity,
          Code: d.Code,
          Year: d.Year,
          Emission: d.Emission
        };
      });

      const mapData = Object.values(countryData);

      // Find emission extent for color scaling (only for countries with data this year)
      const emissionExtent = d3.extent(mapData, d => d.Emission);
      const minEmission = emissionExtent[0] || 0;
      const maxEmission = emissionExtent[1] || 10;

      // Load world map specification from external file
      const specResponse4 = await fetch("specs/world-co2-map.json");
      const baseSpec4 = await specResponse4.json();
      
      // Update dynamic parts: data, color domain, and year references
      const spec4 = {
        ...baseSpec4,
        transform: [
          {
            ...baseSpec4.transform[0],
            from: {
              ...baseSpec4.transform[0].from,
              data: {
                ...baseSpec4.transform[0].from.data,
                values: mapData  // ‚Üê Inject real filtered data here
              }
            }
          }
        ],
        encoding: {
          ...baseSpec4.encoding,
          color: {
            ...baseSpec4.encoding.color,
            scale: {
              ...baseSpec4.encoding.color.scale,
              domain: [minEmission, maxEmission]  // ‚Üê Dynamic color range
            },
            legend: {
              ...baseSpec4.encoding.color.legend,
              title: `CO‚ÇÇ kibocs√°t√°s (tonna/f≈ë, ${selectedYear})`  // ‚Üê Dynamic year
            }
          }
        },
        projection: {
          ...baseSpec4.projection,
          scale: 120  // Slightly larger for better visibility
        }
      };

      // Clear previous visualization
      d3.select("#vis4").selectAll("*").remove();
      
      // Embed the map
      vegaEmbed("#vis4", spec4, {actions: false}).then(result => {
        // Add custom tooltip handling if needed
        const view = result.view;
        view.addEventListener('mouseover', function(event, item) {
          if (item && item.datum && item.datum.Entity) {
            const tooltip = d3.select("#mapTooltip");
            tooltip
              .style("opacity", 1)
              .html(`${item.datum.Entity}<br/>CO‚ÇÇ (${selectedYear}): ${item.datum.Emission.toFixed(2)} t/f≈ë`);
          }
        });

        view.addEventListener('mousemove', function(event) {
          d3.select("#mapTooltip")
            .style("left", (event.pageX + 10) + "px")
            .style("top", (event.pageY - 10) + "px");
        });

        view.addEventListener('mouseout', function() {
          d3.select("#mapTooltip").style("opacity", 0);
        });
      }).catch(console.error);
    }

    // Event listener for map year selection (like chart 3)
    document.getElementById("mapYearSelect")
      .addEventListener("change", e => drawWorldMap(+e.target.value));

    // Initial map render with default year
    drawWorldMap(2020); // Default year, will be overridden by dropdown population

  </script>
</body>
</html>
